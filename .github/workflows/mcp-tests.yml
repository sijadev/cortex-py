name: 🤖 MCP Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/mcp/**'
      - 'tests/mcp/**'
      - 'validate_mcp_system.py'
      - 'config/mcp/**'
      - '.github/workflows/mcp-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/mcp/**'
      - 'tests/mcp/**'
      - 'validate_mcp_system.py'
      - 'config/mcp/**'
  workflow_call:

env:
  PYTHON_VERSION: "3.11"
  NEO4J_DISABLED: "1"
  CI: "true"

jobs:
  mcp-validation:
    name: MCP System Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-mcp-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-mcp-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Validate MCP system structure
      run: |
        echo "🤖 Validating MCP System..."
        python validate_mcp_system.py

    - name: Run MCP tests
      run: |
        echo "🧪 Running MCP Tests..."
        python -m pytest tests/mcp/ \
          -v \
          --tb=short \
          --junitxml=mcp-test-results.xml

    - name: Check MCP configuration files
      run: |
        echo "⚙️ Checking MCP Configuration..."
        if [ -d "config/mcp" ]; then
          find config/mcp -name "*.json" -exec python -m json.tool {} \; > /dev/null
          echo "✅ MCP JSON configurations are valid"
        fi
        
        if [ -f "config/claude_desktop_config.json" ]; then
          python -m json.tool config/claude_desktop_config.json > /dev/null
          echo "✅ Claude Desktop config is valid JSON"
        fi

    - name: Test MCP debug scripts
      run: |
        echo "🔍 Testing MCP debug capabilities..."
        if [ -f "scripts/debug_mcp.py" ]; then
          python scripts/debug_mcp.py || echo "Debug script completed with warnings"
        fi

    - name: Upload MCP test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: mcp-test-results-${{ github.run_number }}
        path: |
          tests/mcp/reports/
          mcp-test-results.xml
          logs/mcp/
        retention-days: 14

    - name: Generate MCP status report
      if: always()
      run: |
        echo "🤖 MCP System Status" >> $GITHUB_STEP_SUMMARY
        echo "- Configuration validation: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- System structure check: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Debug capabilities: ✅" >> $GITHUB_STEP_SUMMARY
