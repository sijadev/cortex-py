name: ðŸŽ¯ Complete CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'  # TÃ¤glich um 1 Uhr UTC

env:
  PYTHON_VERSION: "3.11"

jobs:
  trigger-smoke-tests:
    name: ðŸ§ª Smoke Tests
    uses: ./.github/workflows/smoke-tests.yml

  trigger-unit-tests:
    name: ðŸ”¬ Unit Tests
    needs: trigger-smoke-tests
    uses: ./.github/workflows/unit-tests.yml
    with:
      coverage-threshold: '85'

  trigger-integration-tests:
    name: ðŸ”— Integration Tests
    needs: trigger-unit-tests
    uses: ./.github/workflows/integration-tests.yml

  trigger-cli-tests:
    name: âš¡ CLI Tests
    needs: trigger-smoke-tests
    uses: ./.github/workflows/cli-tests.yml

  trigger-mcp-tests:
    name: ðŸ¤– MCP Tests
    needs: trigger-smoke-tests
    uses: ./.github/workflows/mcp-tests.yml

  trigger-security-quality:
    name: ðŸ”’ Security & Quality
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    uses: ./.github/workflows/security-quality.yml

  build-status-report:
    name: ðŸ“Š Build Status Report
    runs-on: ubuntu-latest
    needs: [
      trigger-smoke-tests,
      trigger-unit-tests,
      trigger-integration-tests,
      trigger-cli-tests,
      trigger-mcp-tests
    ]
    if: always()
    timeout-minutes: 5

    steps:
    - name: Generate comprehensive report
      run: |
        echo "# ðŸŽ¯ Cortex CI Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results Overview" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Smoke Tests
        if [ "${{ needs.trigger-smoke-tests.result }}" = "success" ]; then
          echo "- ðŸ§ª Smoke Tests: âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ§ª Smoke Tests: âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Unit Tests  
        if [ "${{ needs.trigger-unit-tests.result }}" = "success" ]; then
          echo "- ðŸ”¬ Unit Tests: âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ”¬ Unit Tests: âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration Tests
        if [ "${{ needs.trigger-integration-tests.result }}" = "success" ]; then
          echo "- ðŸ”— Integration Tests: âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ”— Integration Tests: âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # CLI Tests
        if [ "${{ needs.trigger-cli-tests.result }}" = "success" ]; then
          echo "- âš¡ CLI Tests: âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš¡ CLI Tests: âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # MCP Tests
        if [ "${{ needs.trigger-mcp-tests.result }}" = "success" ]; then
          echo "- ðŸ¤– MCP Tests: âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ¤– MCP Tests: âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Overall Status" >> $GITHUB_STEP_SUMMARY
        
        # Check overall status
        if [[ "${{ needs.trigger-smoke-tests.result }}" == "success" && \
              "${{ needs.trigger-unit-tests.result }}" == "success" && \
              "${{ needs.trigger-integration-tests.result }}" == "success" && \
              "${{ needs.trigger-cli-tests.result }}" == "success" && \
              "${{ needs.trigger-mcp-tests.result }}" == "success" ]]; then
          echo "ðŸŽ‰ **ALL TESTS PASSED** - Ready for deployment!" >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "âš ï¸ **SOME TESTS FAILED** - Review required before merge" >> $GITHUB_STEP_SUMMARY  
          exit 1
        fi
